
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏≠‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Simple loader animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="container mx-auto max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h1>
            <p class="text-gray-600 mt-2">Activity Recording & Dashboard</p>
        </header>

        <main class="bg-white p-6 rounded-2xl shadow-lg">
            <!-- Navigation Tabs -->
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button id="tab-record" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-indigo-600 border-indigo-500">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                    </button>
                    <button id="tab-dashboard" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Dashboard
                    </button>
                    <button id="tab-activities" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                    </button>
                </nav>
            </div>

            <!-- Message/Status Display Area -->
            <div id="message-area" class="my-4 p-4 rounded-lg text-center text-white font-semibold hidden"></div>

            <!-- View: Record Activity -->
            <div id="view-record" class="mt-6">
                <form id="activity-form" class="space-y-6">
                    <div>
                        <label for="user-pscode" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (PScode)</label>
                        <input type="text" id="user-pscode" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                        <div id="user-info" class="mt-2 text-sm text-gray-600 hidden"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="activity-select" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <select id="activity-select" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...</option>
                            </select>
                        </div>
                        <div>
                             <label for="activity-round" class="block text-sm font-medium text-gray-700">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà (Round)</label>
                             <select id="activity-round" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</option>
                                <option value="1">‡∏£‡∏≠‡∏ö 1</option>
                                <option value="2">‡∏£‡∏≠‡∏ö 2</option>
                             </select>
                        </div>
                    </div>

                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                    <div id="activity-details" class="bg-blue-50 p-4 rounded-lg hidden">
                        <h3 class="text-sm font-medium text-blue-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h3>
						<div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î:</span>
                                <span id="activity-date" class="font-medium text-gray-800 ml-2">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">‡∏£‡∏≠‡∏ö:</span>
                                <span id="activity-round-display" class="font-medium text-gray-800 ml-2">-</span>
                            </div>
                            <div>
                                <span class="text-gray-600">‡∏õ‡∏µ ‡∏û.‡∏®.:</span>
                                <span id="activity-year" class="font-medium text-gray-800 ml-2">-</span>
                            </div>
							<div>
								<span class="text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
								<span id="activity-status" class="font-medium ml-2 text-green-600">-</span>
							</div>
                        </div>
                    </div>

                    <div>
                        <label for="image-upload" class="block text-sm font-medium text-gray-700">
                            ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢ <span class="text-gray-400 font-normal">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span>
                        </label>
                        <div class="flex items-center space-x-2">
                            <input type="file" id="image-upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                            <button type="button" id="clear-image" class="hidden mt-1 px-3 py-1 text-xs bg-red-100 text-red-600 rounded hover:bg-red-200" onclick="clearImageUpload()">
                                ‡∏•‡πâ‡∏≤‡∏á
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: JPG, PNG, WEBP) ‚Ä¢ <strong>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏î‡πâ</strong></p>
                        <div id="image-preview" class="mt-2 hidden">
                            <img id="preview-img" class="w-32 h-32 object-cover rounded-lg border" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û">
                            <p class="text-xs text-gray-500 mt-1">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (GPS)</label>
                        <div id="location-status" class="mt-1 text-sm text-gray-600 bg-gray-50 p-3 rounded-md">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î...
                        </div>
                        <div id="coordinates-display" class="mt-2 text-xs text-gray-500 hidden">
                            <span class="font-medium">‡∏û‡∏¥‡∏Å‡∏±‡∏î:</span> <span id="coords-text">-</span>
                        </div>
                    </div>

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö) -->
                    <div id="record-summary" class="bg-green-50 p-4 rounded-lg hidden">
                        <h3 class="text-sm font-medium text-green-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
                        <div class="text-sm space-y-1 text-gray-700">
                            <div><span class="font-medium">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</span> <span id="summary-user">-</span></div>
                            <div><span class="font-medium">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</span> <span id="summary-activity">-</span></div>
                            <div><span class="font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î:</span> <span id="summary-date">-</span></div>
                            <div><span class="font-medium">‡∏£‡∏≠‡∏ö:</span> <span id="summary-round">-</span></div>
                            <div><span class="font-medium">‡∏õ‡∏µ:</span> <span id="summary-year">-</span></div>
                            <div><span class="font-medium">‡∏†‡∏≤‡∏û:</span> <span id="summary-image" class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û</span></div>
                            <div><span class="font-medium">‡∏û‡∏¥‡∏Å‡∏±‡∏î:</span> <span id="summary-coords">-</span></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="showUpdateURLDialog()" class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 011.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 01-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.397.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 01-.12-1.45l.527-.737c.25-.35.273-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.107-1.204l-.527-.738a1.125 1.125 0 01.12-1.45l.773-.773a1.125 1.125 0 011.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL
                        </button>
                        <button type="button" onclick="testConnection()" class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.416 1.75-.956l11.5 6.347c.833.46.833 1.653 0 2.113l-11.5 6.347c-.833.46-1.75-.1-1.75-.956V5.653Z" />
                            </svg>
                            ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                        </button>
                        <button type="submit" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                             <svg id="submit-icon" class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            <span id="submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                            <div id="submit-loader" class="loader w-5 h-5 ml-2 hidden"></div>
                        </button>
                    </div>
                </form>
            </div>

            <!-- View: Dashboard -->
            <div id="view-dashboard" class="mt-6 hidden">
                <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <label for="year-filter" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label>
                        <select id="year-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <!-- Year options will be populated here -->
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="round-filter" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö</label>
                        <select id="round-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <!-- Round options will be populated here -->
                        </select>
                    </div>
                    <div class="self-end">
                         <button id="load-dashboard-btn" class="w-full md:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                        </button>
                    </div>
					<div class="self-end">
						 <button id="export-excel-btn" class="w-full md:w-auto inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-indigo-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
							‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
						</button>
					</div>
                </div>

                <div id="dashboard-results" class="space-y-4">
                    <div class="text-center p-8 text-gray-500">
                        ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•"
                    </div>
                </div>
                 <div id="dashboard-loader" class="flex justify-center p-8 hidden">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- View: Activity Management -->
            <div id="view-activities" class="mt-6 hidden">
                <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-6 rounded-lg mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üéØ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
                    <p class="text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
                </div>

                <!-- Add Activity Form -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
                    <form id="add-activity-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label for="activity-id" class="block text-sm font-medium text-gray-700">
                                    ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
									<span class="text-gray-500 text-xs">- ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ACT[‡∏õ‡∏µ][‡∏£‡∏≠‡∏ö][‡∏•‡∏≥‡∏î‡∏±‡∏ö] (‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</span>
                                </label>
								<input type="text" id="activity-id" disabled
									   class="mt-1 block w-full px-3 py-2 border border-gray-200 bg-gray-50 text-gray-500 rounded-md shadow-sm sm:text-sm cursor-not-allowed"
									   placeholder="‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" value="(Auto)">
                                <div id="activity-id-preview" class="mt-1 text-sm text-indigo-600"></div>
                            </div>
                            <div>
                                <label for="activity-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                                <input type="text" id="activity-name" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                       placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô">
                            </div>
                            <div>
								<label for="activity-date-input" class="block text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î</label>
								<input type="date" id="activity-date-input" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="activity-round-input" class="block text-sm font-medium text-gray-700">‡∏£‡∏≠‡∏ö</label>
                                <input type="number" id="activity-round-input" required min="1" max="2" value="1"
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                       placeholder="1-2">
                            </div>
                            <div>
                                <label for="activity-year-input" class="block text-sm font-medium text-gray-700">‡∏õ‡∏µ ‡∏û.‡∏®.</label>
                                <input type="number" id="activity-year-input" required min="2560" max="2600" value="2568"
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                       placeholder="2567">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                </svg>
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Activity List -->
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <button onclick="refreshActivityList()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg>
                            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="mb-4 flex flex-col sm:flex-row gap-3">
                        <div class="flex-1">
                            <input type="text" id="activity-search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..."
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <select id="year-filter-activities" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Activities Table -->
                    <div class="overflow-x-auto">
                        <div id="activities-loader" class="flex justify-center p-8 hidden">
                            <div class="loader"></div>
                        </div>
                        <div id="activities-table-container">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
									<tr>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≠‡∏ö</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏õ‡∏µ</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
									</tr>
                                </thead>
								<tbody id="activities-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
										<td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
	<script>
		// --- CONFIGURATION ---
		// !!! IMPORTANT !!!
		// Google Apps Script Web App URL ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
		// ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Deploy ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
		const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzSHNJ4N2r30OFlYvnOhs5VlVkJHY66_RdvsKIsoi7JXm0MTTFNW41Q__1XdCf3WYDxQw/exec";
		
		// URL ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà URL ‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
		const BACKUP_SCRIPT_URL = ""; // ‡πÉ‡∏™‡πà URL ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏≤‡∏Å‡∏°‡∏µ
		
		// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
		function validateScriptURL() {
			const currentURL = window.SCRIPT_URL || SCRIPT_URL;
			if (!currentURL || currentURL === "") {
				throw new Error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Google Apps Script URL ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SCRIPT_URL ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
			}
			if (!currentURL.includes("script.google.com/macros")) {
				throw new Error("‚ùå URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ URL ‡∏à‡∏≤‡∏Å Google Apps Script deployment");
			}
			console.log("‚úÖ Script URL validated:", currentURL);
			return currentURL;
		}

		// --- DOM ELEMENTS ---
		const tabRecord = document.getElementById('tab-record');
		const tabDashboard = document.getElementById('tab-dashboard');
		const tabActivities = document.getElementById('tab-activities');
		const viewRecord = document.getElementById('view-record');
		const viewDashboard = document.getElementById('view-dashboard');
		const viewActivities = document.getElementById('view-activities');
		const activityForm = document.getElementById('activity-form');
		const activitySelect = document.getElementById('activity-select');
		const activityRound = document.getElementById('activity-round');
		const imageUpload = document.getElementById('image-upload');
		const locationStatus = document.getElementById('location-status');
		const messageArea = document.getElementById('message-area');
		const submitBtnText = document.getElementById('submit-text');
		const submitBtnLoader = document.getElementById('submit-loader');
		
		// New elements for updated form
		const userPscode = document.getElementById('user-pscode');
		const userInfo = document.getElementById('user-info');
		const activityDetails = document.getElementById('activity-details');
		const activityDate = document.getElementById('activity-date');
		const activityRoundDisplay = document.getElementById('activity-round-display');
		
		// Activity Management elements
		const addActivityForm = document.getElementById('add-activity-form');
		const activitiesTableBody = document.getElementById('activities-table-body');
		const activitiesLoader = document.getElementById('activities-loader');
		const activitySearch = document.getElementById('activity-search');
		const yearFilterActivities = document.getElementById('year-filter-activities');
		const activityYear = document.getElementById('activity-year');
		const imagePreview = document.getElementById('image-preview');
		const previewImg = document.getElementById('preview-img');
		const coordinatesDisplay = document.getElementById('coordinates-display');
		const coordsText = document.getElementById('coords-text');
		const recordSummary = document.getElementById('record-summary');
		
		// Dashboard elements
		const yearFilter = document.getElementById('year-filter');
		const roundFilter = document.getElementById('round-filter');
		const loadDashboardBtn = document.getElementById('load-dashboard-btn');
		const exportExcelBtn = document.getElementById('export-excel-btn');
		const dashboardResults = document.getElementById('dashboard-results');
		const dashboardLoader = document.getElementById('dashboard-loader');

		// --- STATE ---
		let userCoordinates = null;
		let isSubmitting = false;
		let currentUser = null;
		let currentActivities = null;
		let currentCoordinates = null;

		// --- FUNCTIONS ---

		/**
		 * Shows a message to the user.
		 * @param {string} text - The message text.
		 * @param {('success'|'error')} type - The message type.
		 */
		function showMessage(text, type) {
			messageArea.textContent = text;
			messageArea.className = `my-4 p-4 rounded-lg text-center font-semibold ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
			messageArea.classList.remove('hidden');
			setTimeout(() => messageArea.classList.add('hidden'), 5000);
		}

		/**
		 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å PScode
		 */
		async function checkUser(pscode) {
			if (!pscode || pscode.length < 3) {
				userInfo.classList.add('hidden');
				return;
			}
			
			try {
				const response = await fetchFromScript('getUserInfo', { pscode });
				if (response.status === 'success') {
					currentUser = response.user;
					userInfo.innerHTML = `
						<div class="text-green-600">
							<span class="font-medium">${currentUser.fullName}</span> | 
							${currentUser.group} | ${currentUser.level} | 
							${currentUser.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'}
						</div>
					`;
					userInfo.classList.remove('hidden');
					updateRecordSummary();
				} else {
					currentUser = null;
					userInfo.innerHTML = `<div class="text-red-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>`;
					userInfo.classList.remove('hidden');
				}
			} catch (error) {
				console.error('Error checking user:', error);
				userInfo.innerHTML = `<div class="text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>`;
				userInfo.classList.remove('hidden');
			}
		}

		/**
		 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
		 */
		function updateActivityDetails(selectedActivity) {
			if (!selectedActivity || !currentActivities) {
				activityDetails.classList.add('hidden');
				// ‡πÑ‡∏°‡πà clear ‡∏Ñ‡πà‡∏≤ round ‡∏ó‡∏µ‡πà user ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
				return;
			}

			const activity = currentActivities.find(act => act.name === selectedActivity);
			if (activity) {
				activityDate.textContent = activity.date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
				activityRoundDisplay.textContent = activity.round || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
				activityYear.textContent = activity.buddhistYear || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
				// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå status ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô default = true)
				const statusEl = document.getElementById('activity-status');
				let statusValue = (typeof activity.status !== 'undefined') ? activity.status : true;
				const statusText = statusValue === true || statusValue === 'true' || statusValue === 1 ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î';
				statusEl.textContent = statusText;
				statusEl.className = 'font-medium ml-2 ' + (statusText === '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' ? 'text-green-600' : 'text-red-600');
				// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö‡πÉ‡∏ô select ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏™‡∏°‡∏≠ (‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
				activityRound.value = activity.round || '';
				activityRound.classList.remove('border-red-500');
				activityDetails.classList.remove('hidden');
				updateRecordSummary();
			}
		}

		/**
		 * ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
		 */
		function previewImage(file) {
			if (file) {
				const reader = new FileReader();
				reader.onload = function(e) {
					previewImg.src = e.target.result;
					imagePreview.classList.remove('hidden');
					updateRecordSummary();
				};
				reader.readAsDataURL(file);
			}
		}

		/**
		 * ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û
		 */
		function clearImageUpload() {
			imageUpload.value = '';
			imagePreview.classList.add('hidden');
			document.getElementById('clear-image').classList.add('hidden');
			updateRecordSummary();
		}

		/**
		 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
		 */
		function updateCoordinatesDisplay(latitude, longitude) {
			if (latitude && longitude) {
				const coords = `${latitude}, ${longitude}`;
				coordsText.textContent = coords;
				coordinatesDisplay.classList.remove('hidden');
				currentCoordinates = coords;
				updateRecordSummary();
			}
		}

		/**
		 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
		 */
		function updateRecordSummary() {
			if (!currentUser) {
				recordSummary.classList.add('hidden');
				return;
			}

			const selectedActivity = activitySelect.value;
			const selectedImage = imageUpload.files[0];
			
			document.getElementById('summary-user').textContent = `${currentUser.fullName} (${currentUser.pscode})`;
			document.getElementById('summary-activity').textContent = selectedActivity || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
			document.getElementById('summary-date').textContent = activityDate.textContent || '-';
			document.getElementById('summary-round').textContent = activityRoundDisplay.textContent || '-';
			document.getElementById('summary-year').textContent = activityYear.textContent || '-';
			
			// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏†‡∏≤‡∏û
			const imageElement = document.getElementById('summary-image');
			if (selectedImage) {
				imageElement.textContent = `‚úÖ ${selectedImage.name}`;
				imageElement.className = 'text-green-600';
			} else {
				imageElement.textContent = 'üì∑ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û';
				imageElement.className = 'text-gray-500';
			}
			
			document.getElementById('summary-coords').textContent = currentCoordinates || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î...';

			// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏Å‡πá‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ
			if (selectedActivity && currentCoordinates) {
				recordSummary.classList.remove('hidden');
			}
		}

		/**
		 * Switches between the record and dashboard views.
		 * @param {('record'|'dashboard'|'activities')} viewName - The view to show.
		 */
		function switchView(viewName) {
			// ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å view
			viewRecord.classList.add('hidden');
			viewDashboard.classList.add('hidden');
			viewActivities.classList.add('hidden');
			
			// ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï tab styles
			[tabRecord, tabDashboard, tabActivities].forEach(tab => {
				tab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
				tab.classList.remove('text-indigo-600', 'border-indigo-500');
			});
			
			// ‡πÅ‡∏™‡∏î‡∏á view ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô tab style
			if (viewName === 'record') {
				viewRecord.classList.remove('hidden');
				tabRecord.classList.add('text-indigo-600', 'border-indigo-500');
				tabRecord.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
			} else if (viewName === 'dashboard') {
				viewDashboard.classList.remove('hidden');
				tabDashboard.classList.add('text-indigo-600', 'border-indigo-500');
				tabDashboard.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
			} else if (viewName === 'activities') {
				viewActivities.classList.remove('hidden');
				tabActivities.classList.add('text-indigo-600', 'border-indigo-500');
				tabActivities.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
				// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
				loadActivitiesList();
			}
		}
		
		/**
		 * Converts a file to a Base64 string.
		 * @param {File} file - The file to convert.
		 * @returns {Promise<string>} A promise that resolves with the Base64 string.
		 */
		function fileToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result.split(',')[1]); // Remove the data URI prefix
				reader.onerror = error => reject(error);
			});
		}
		
		/**
		 * Fetches data from the Google Apps Script backend.
		 * @param {string} action - The action to perform.
		 * @param {object} [payload={}] - The data to send.
		 * @returns {Promise<any>} A promise that resolves with the response data.
		 */
		async function fetchFromScript(action, payload = {}) {
			try {
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
				const currentURL = validateScriptURL();
				
				console.log('üöÄ Attempting to fetch:', action, payload);
				console.log('üìç Script URL:', currentURL);
				
				// ‡πÉ‡∏ä‡πâ GET request ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS preflight
				const params = new URLSearchParams({ 
					action, 
					data: JSON.stringify(payload) 
				});
				
				const fullUrl = `${currentURL}?${params}`;
				console.log('üîó Full URL:', fullUrl);
				
				// ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ timeout
				const controller = new AbortController();
				const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ timeout
				
				const response = await fetch(fullUrl, {
					method: 'GET',
					mode: 'cors',
					headers: {
						'Accept': 'application/json',
					},
					signal: controller.signal
				});
				
				clearTimeout(timeoutId);
				
				console.log('üì® Response status:', response.status);
				console.log('üì® Response ok:', response.ok);
				
				if (!response.ok) {
					const errorText = await response.text();
					console.error('‚ùå Response error text:', errorText);
					throw new Error(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å Server: ${response.status} - ${response.statusText}`);
				}
				
				const result = await response.json();
				console.log('‚úÖ Response result:', result);
				return result;
				
			} catch (error) {
				console.error('‚ùå Fetch error details:', {
					message: error.message,
					stack: error.stack,
					name: error.name
				});
				
				// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
				if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
					throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ\n\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:\n1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï\n2. Google Apps Script ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Deploy ‡∏´‡∏£‡∏∑‡∏≠ URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n3. ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà\n4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°');
				}
				
				if (error.name === 'AbortError') {
					throw new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
				}
				
				throw error;
			}
		}

		// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
		async function testConnection() {
			try {
				console.log('üß™ Testing connection to Google Apps Script...');
				showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'info');
				
				// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö URL ‡∏Å‡πà‡∏≠‡∏ô
				validateScriptURL();
				
				const result = await fetchFromScript('getInitialData');
				if (result.status === 'success') {
					showMessage('‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
					console.log('‚úÖ Connection test successful');
					return true;
				} else {
					showMessage('‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + result.message, 'error');
					console.error('‚ùå Connection test failed:', result);
					return false;
				}
			} catch (error) {
				const errorMsg = error.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
				showMessage('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ' + errorMsg, 'error');
				console.error('‚ùå Connection test error:', error);
				
				// ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
				showTroubleshootingSteps();
				return false;
			}
		}

		// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤
		function showTroubleshootingSteps() {
			const troubleshootDiv = document.createElement('div');
			troubleshootDiv.className = 'mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md';
			troubleshootDiv.innerHTML = `
				<h3 class="text-lg font-semibold text-yellow-800 mb-2">üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</h3>
				<ol class="list-decimal list-inside text-sm text-yellow-700 space-y-1">
					<li>‡πÄ‡∏õ‡∏¥‡∏î Google Apps Script: <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">script.google.com</a></li>
					<li>‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ "Pharm_event" ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</li>
					<li>‡∏Ñ‡∏•‡∏¥‡∏Å Deploy ‚Üí New deployment</li>
					<li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Type: Web app</li>
					<li>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Execute as: Me, Who has access: Anyone</li>
					<li>‡∏Ñ‡∏•‡∏¥‡∏Å Deploy ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÉ‡∏´‡∏°‡πà</li>
					<li>‡∏ô‡∏≥ URL ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ SCRIPT_URL ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå HTML</li>
					<li>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</li>
				</ol>
				<button onclick="this.parentElement.remove()" class="mt-2 px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700">
					‡∏õ‡∏¥‡∏î
				</button>
			`;
			
			const container = document.querySelector('.container');
			container.insertBefore(troubleshootDiv, container.firstChild);
		}

		// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà fetch ‡∏´‡∏•‡∏±‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
		async function fetchFromScriptFallback(action, payload = {}) {
			try {
				console.log('üîÑ Using fallback fetch method...');
				
				// ‡∏™‡∏£‡πâ‡∏≤‡∏á form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
				const form = document.createElement('form');
				form.method = 'POST';
				form.action = SCRIPT_URL;
				form.target = '_blank';
				
				// ‡πÄ‡∏û‡∏¥‡πà‡∏° input fields
				const actionInput = document.createElement('input');
				actionInput.type = 'hidden';
				actionInput.name = 'action';
				actionInput.value = action;
				form.appendChild(actionInput);
				
				const dataInput = document.createElement('input');
				dataInput.type = 'hidden';
				dataInput.name = 'data';
				dataInput.value = JSON.stringify(payload);
				form.appendChild(dataInput);
				
				document.body.appendChild(form);
				form.submit();
				document.body.removeChild(form);
				
				return { status: 'success', message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà' };
				
			} catch (error) {
				console.error('‚ùå Fallback method error:', error);
				throw error;
			}
		}

		// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Dialog ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL
		function showUpdateURLDialog() {
			const overlay = document.createElement('div');
			overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
			overlay.innerHTML = `
				<div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
					<h3 class="text-lg font-semibold mb-4">üîß ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Google Apps Script URL</h3>
					<p class="text-sm text-gray-600 mb-4">
						‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Deploy Google Apps Script ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà URL ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
					</p>
					<input type="text" id="newScriptURL" value="${SCRIPT_URL}" 
						   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm mb-4"
						   placeholder="https://script.google.com/macros/s/.../exec">
					<div class="flex justify-end space-x-3">
						<button onclick="closeURLDialog()" 
								class="px-4 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">
							‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
						</button>
						<button onclick="updateScriptURL()" 
								class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700">
							‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL
						</button>
					</div>
					<div class="mt-4 text-xs text-gray-500">
						<strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏≤ URL ‡πÉ‡∏´‡∏°‡πà:</strong><br>
						1. ‡πÄ‡∏õ‡∏¥‡∏î <a href="https://script.google.com" target="_blank" class="text-blue-600">script.google.com</a><br>
						2. Deploy ‚Üí New deployment ‚Üí Web app<br>
						3. Execute as: Me, Who has access: Anyone<br>
						4. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
					</div>
				</div>
			`;
			
			window.closeURLDialog = function() {
				document.body.removeChild(overlay);
			};
			
			window.updateScriptURL = function() {
				const newURL = document.getElementById('newScriptURL').value.trim();
				if (newURL && newURL.includes('script.google.com/macros')) {
					// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL (‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ localStorage)
					window.SCRIPT_URL = newURL;
					showMessage('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'success');
					closeURLDialog();
				} else {
					showMessage('‚ùå URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏à‡∏≤‡∏Å Google Apps Script', 'error');
				}
			};
			
			document.body.appendChild(overlay);
		}

		/**
		 * Fetches and populates the activity dropdown.
		 */
		async function loadActivities() {
			try {
				const response = await fetchFromScript('getInitialData');
				if (response.status === 'success') {
					// filter ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà active ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
					const onlyActive = (response.activities || []).filter(a => {
						const v = (a && a.status !== undefined) ? a.status : 'TRUE';
						return v === true || v === 1 || String(v).toUpperCase() === 'TRUE';
					});
					currentActivities = onlyActive;

					// Populate Activities (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ active)
					activitySelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>';
					if (onlyActive.length === 0) {
						const option = document.createElement('option');
						option.value = '';
						option.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
						activitySelect.appendChild(option);
					} else {
						onlyActive.forEach(activity => {
							const option = document.createElement('option');
							option.value = activity.name;
							option.textContent = `${activity.name} (${activity.date}) ‡∏£‡∏≠‡∏ö ${activity.round} ‡∏õ‡∏µ ${activity.buddhistYear}`;
							activitySelect.appendChild(option);
						});
					}

					// Populate Year Filter (‡πÉ‡∏ä‡πâ‡∏õ‡∏µ ‡∏û.‡∏®.)
					yearFilter.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ --</option>';
					if (response.filters.buddhistYears) {
						response.filters.buddhistYears.forEach(year => {
							const option = document.createElement('option');
							option.value = year;
							option.textContent = `‡∏õ‡∏µ ${year}`;
							yearFilter.appendChild(option);
						});
					}
					
					// Populate Round Filter
					roundFilter.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö --</option>';
					response.filters.rounds.forEach(round => {
						const option = document.createElement('option');
						option.value = round;
						option.textContent = `‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${round}`;
						roundFilter.appendChild(option);
					});

					showMessage('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
				} else {
					throw new Error(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ');
				}
			} catch (error) {
				activitySelect.innerHTML = '<option>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</option>';
				showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
				console.error('Error loading initial data:', error);
			}
		}
		
		/**
		 * Gets the user's GPS coordinates.
		 */
		function getCoordinates() {
			if (navigator.geolocation) {
				locationStatus.innerHTML = '<div class="flex items-center"><div class="loader w-4 h-4 mr-2"></div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î...</div>';
				navigator.geolocation.getCurrentPosition(
					(position) => {
						userCoordinates = {
							latitude: position.coords.latitude,
							longitude: position.coords.longitude,
						};
						const coordsStr = `${userCoordinates.latitude.toFixed(6)}, ${userCoordinates.longitude.toFixed(6)}`;
						locationStatus.innerHTML = `<div class="text-green-600 flex items-center">
							<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
								<path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
							</svg>
							‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
						</div>`;
						updateCoordinatesDisplay(userCoordinates.latitude, userCoordinates.longitude);
					},
					(error) => {
						locationStatus.innerHTML = `<div class="text-red-600">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>`;
						console.error('Geolocation error:', error);
					},
					{
						enableHighAccuracy: true,
						timeout: 10000,
						maximumAge: 300000
					}
				);
			} else {
				locationStatus.innerHTML = `<div class="text-red-600">‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation</div>`;
			}
		}

		/**
		 * Handles the activity form submission.
		 */
		async function handleFormSubmit(event) {
			console.log('üìù Form submission started');
			event.preventDefault();
			
			if (isSubmitting) {
				console.log('‚è∏Ô∏è Form submission already in progress, ignoring');
				return;
			}

			try {
				// ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
				const pscode = document.getElementById('user-pscode').value.trim();
				const activity = activitySelect.value;
				const round = document.getElementById('activity-round').value;
				const imageFile = imageUpload.files[0]; // ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô undefined ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå

				console.log('üìã Form data:', { 
					pscode, 
					activity, 
					round, 
					hasImage: !!imageFile,
					userCoordinates,
					currentCoordinates 
				});

				// ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏Å‡πá‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ
				if (!pscode || !activity || !round) {
					console.log('‚ùå Required fields missing:', {
						pscode: pscode || '‡∏ß‡πà‡∏≤‡∏á',
						activity: activity || '‡∏ß‡πà‡∏≤‡∏á', 
						round: round || '‡∏ß‡πà‡∏≤‡∏á'
					});
					
					let missingFields = [];
					if (!pscode) missingFields.push('PScode ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
					if (!activity) missingFields.push('‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
					if (!round) missingFields.push('‡∏£‡∏≠‡∏ö');
					
					showMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö: ${missingFields.join(', ')}`, 'error');
					return;
				}
				
				if (!userCoordinates) {
					console.log('‚ùå User coordinates missing');
					showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î', 'error');
					return;
				}

				// ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
				isSubmitting = true;
				submitBtnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
				submitBtnLoader.classList.remove('hidden');
				console.log('‚è≥ Submission in progress...');

				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
				let imageData = null;
				if (imageFile) {
					console.log('üñºÔ∏è Processing image file...');
					const imageBase64 = await fileToBase64(imageFile);
					imageData = {
						filename: imageFile.name,
						data: imageBase64
					};
					console.log('‚úÖ Image processed successfully');
				} else {
					console.log('‚ÑπÔ∏è No image file selected');
				}
				
				const payload = {
					pscode,
					activity,
					round, // ‡πÄ‡∏û‡∏¥‡πà‡∏° round ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
					image: imageData, // ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û
					coordinates: currentCoordinates,
					latitude: userCoordinates.latitude,
					longitude: userCoordinates.longitude
				};

				console.log('üì§ Sending payload:', payload);
				const response = await fetchFromScript('addRecord', payload);
				console.log('üì• Received response:', response);
				
				if (response.status === 'success') {
					// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
					const imageStatus = imageFile ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö';
					showMessage(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${imageStatus})`, 'success');
					
					// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
					if (response.record) {
						showMessage(`üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${response.record.activity} (ID: ${response.record.idrecord})`, 'success');
					}
					
					console.log('‚úÖ Form submitted successfully, resetting form...');
					
					// Reset form
					activityForm.reset();
					userInfo.classList.add('hidden');
					activityDetails.classList.add('hidden');
					imagePreview.classList.add('hidden');
					coordinatesDisplay.classList.add('hidden');
					recordSummary.classList.add('hidden');
					currentUser = null;
					
					// Get coordinates again
					getCoordinates();
					
					console.log('üîÑ Form reset completed');
				} else {
					// ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥ (‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°-‡∏£‡∏≠‡∏ö-‡∏õ‡∏µ-‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
					if (response.code === 'DUPLICATE') {
						showMessage('‚ùó ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°-‡∏£‡∏≠‡∏ö-‡∏õ‡∏µ ‡∏ã‡πâ‡∏≥)', 'error');
						console.warn('Duplicate submission prevented:', response);
						return;
					}

					console.error('‚ùå Server returned error status:', response);
					throw new Error(response.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
				}

			} catch (error) {
				console.error('‚ùå Form submission error:', error);
				console.error('‚ùå Error stack:', error.stack);
				showMessage(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
				
				// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
				if (window.location.search.includes('debug=true')) {
					console.log('üîç Debug mode: showing detailed error info');
					showMessage(`üîç Debug Info: ${error.name} - ${error.message}`, 'error');
				}
			} finally {
				isSubmitting = false;
				submitBtnText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
				submitBtnLoader.classList.add('hidden');
				console.log('üèÅ Form submission process completed');
			}
		}

		/**
		 * Loads and displays dashboard data.
		 */
		async function loadDashboardData() {
			dashboardLoader.classList.remove('hidden');
			dashboardResults.innerHTML = '';

			try {
				const year = yearFilter.value;
				const round = roundFilter.value;

				const response = await fetchFromScript('getDashboardData', { year, round });
				if (response.status === 'success') {
					renderDashboard(response.data);
				} else {
					throw new Error(response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard ‡πÑ‡∏î‡πâ');
				}
			} catch (error) {
				 dashboardResults.innerHTML = `<div class="text-center p-8 text-red-500">${error.message}</div>`;
				 console.error('Dashboard loading error:', error);
			} finally {
				 dashboardLoader.classList.add('hidden');
			}
		}

		/**
		 * Renders the dashboard UI from processed data.
		 * @param {object} data - The data from the backend.
		 */
		function renderDashboard(data) {
			 if (Object.keys(data.summary).length === 0) {
				dashboardResults.innerHTML = `<div class="text-center p-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
				return;
			}

			let html = `<h3 class="text-xl font-semibold text-gray-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏£‡∏ß‡∏° ${data.totalRecords} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>`;
			
			// ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
			html += `<div class="overflow-x-auto mb-6"><table class="min-w-full bg-white border border-gray-200">
						<thead class="bg-gray-50">
							<tr>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-gray-200">`;
			
			for (const activity in data.summary) {
				html += `<tr>
							<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${activity}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.summary[activity]} ‡∏Ñ‡∏ô</td>
						 </tr>`;
			}

			html += `</tbody></table></div>`;
			
			// ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
			if (data.userSummary && Object.keys(data.userSummary).length > 0) {
				html += `<h4 class="text-lg font-semibold text-gray-800 mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h4>`;
				html += `<div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200">
						<thead class="bg-gray-50">
							<tr>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PScode</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)</th>
							</tr>
						</thead>
						<tbody class="divide-y divide-gray-200">`;
				
				for (const pscode in data.userSummary) {
					const rawList = data.userSummary[pscode];
					const countAll = rawList.length; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
					const distinctActivities = [...new Set(rawList)];
					html += `<tr>
							<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${pscode}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${countAll}</td>
							<td class="px-6 py-4 text-sm text-gray-500">${distinctActivities.join(', ')}</td>
						 </tr>`;
				}
				
				html += `</tbody></table></div>`;
			}
			
			dashboardResults.innerHTML = html;
		}

		// --- ACTIVITY MANAGEMENT FUNCTIONS ---

		/**
		 * ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
		 */
		async function loadActivitiesList() {
			try {
				activitiesLoader.classList.remove('hidden');
				const response = await fetchFromScript('getInitialData');
				
				if (response.status === 'success') {
					displayActivitiesList(response.activities || []);
					populateYearFilter(response.activities || []);
				} else {
					showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ: ' + response.message, 'error');
				}
			} catch (error) {
				console.error('Error loading activities:', error);
				showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
			} finally {
				activitiesLoader.classList.add('hidden');
			}
		}

		/**
		 * ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
		 */
		function displayActivitiesList(activities) {
			if (!activities || activities.length === 0) {
				activitiesTableBody.innerHTML = `
					<tr>
						<td colspan="5" class="px-6 py-4 text-center text-gray-500">
							‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
						</td>
					</tr>
				`;
				return;
			}

			const html = activities.map(activity => {
				// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: activity.date ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/MM/yyyy ‡∏´‡∏£‡∏∑‡∏≠ Date object ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
				let displayDate = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
				if (activity.date && activity.date !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
					try {
						// ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ / ‡πÉ‡∏´‡πâ parsing ‡πÅ‡∏ö‡∏ö manual
						if (typeof activity.date === 'string' && activity.date.includes('/')) {
							const parts = activity.date.split('/'); // dd/MM/yyyy
							if (parts.length === 3) {
								const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
								displayDate = d.toLocaleDateString('th-TH', { day:'numeric', month:'long', year:'numeric' });
							}
						} else {
							const d2 = new Date(activity.date);
							if (!isNaN(d2.getTime())) {
								displayDate = d2.toLocaleDateString('th-TH', { day:'numeric', month:'long', year:'numeric' });
							}
						}
					} catch(e){
						displayDate = activity.date;
					}
				}

				const yearDisplay = activity.buddhistYear || activity.year || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
				const isActive = (activity.status === true || activity.status === 1 || String(activity.status).toUpperCase() === 'TRUE');
				const statusBadge = isActive
					? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>'
					: '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">‡∏õ‡∏¥‡∏î</span>';
				return `
				<tr class="hover:bg-gray-50">
					<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
						${activity.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
					</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
						${displayDate}
					</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
						${activity.round || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
					</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
						${yearDisplay}
					</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
					<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
						<button onclick="editActivity('${activity.name}')" 
								class="text-indigo-600 hover:text-indigo-900 mr-3">
							‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
						</button>
						<button onclick="toggleActivityStatus('${activity.name}')" 
								class="text-yellow-600 hover:text-yellow-800 mr-3">
							‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
						</button>
						<button onclick="deleteActivity('${activity.name}')" 
								class="text-red-600 hover:text-red-900">
							‡∏•‡∏ö
						</button>
					</td>
				</tr>
			`;}).join('');

			activitiesTableBody.innerHTML = html;
		}

		// Toggle ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (TRUE/FALSE)
		async function toggleActivityStatus(activityName){
			try{
				const target = (currentActivities || []).find(a => a.name === activityName);
				// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô currentActivities ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
				const rowEl = Array.from(document.querySelectorAll('#activities-table-body tr')).find(tr => tr.querySelector('td')?.innerText?.trim() === activityName);
				if(!target && !rowEl){
					showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','error');
					return;
				}
				const currentStatus = target?.status ?? 'TRUE';
				const nextStatus = (currentStatus === true || currentStatus === 1 || String(currentStatus).toUpperCase() === 'TRUE') ? 'FALSE' : 'TRUE';
				showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...','info');
				const resp = await fetchFromScript('updateActivity', { originalName: activityName, status: nextStatus });
				if(resp.status==='success'){
					showMessage('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
					await loadActivitiesList();
					await loadActivities();
				}else{
					showMessage('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(resp.message||''),'error');
				}
			}catch(err){
				console.error('toggleActivityStatus error',err);
				showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+err.message,'error');
			}
		}

		/**
		 * ‡πÄ‡∏û‡∏¥‡πà‡∏° Filter ‡∏õ‡∏µ‡πÉ‡∏ô Activity Management
		 */
		function populateYearFilter(activities) {
			const years = [...new Set(activities.map(a => a.year).filter(y => y))].sort((a, b) => b - a);
			
			let html = '<option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option>';
			years.forEach(year => {
				html += `<option value="${year}">${year}</option>`;
			});
			
			yearFilterActivities.innerHTML = html;
		}

		/**
		 * ‡πÅ‡∏™‡∏î‡∏á preview ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
		 */
		function updateActivityIdPreview() {
			const round = document.getElementById('activity-round-input').value;
			const year = document.getElementById('activity-year-input').value;
			const previewElement = document.getElementById('activity-id-preview');
			if (round && year) {
				const yearSuffix = String(year).slice(-2);
				const roundFormatted = String(round).padStart(2, '0');
				previewElement.textContent = `üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á: ACT${yearSuffix}${roundFormatted}xxx (xxx = ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)`;
			} else {
				previewElement.textContent = 'üí° ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™';
			}
		}

		/**
		 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà
		 */
		async function handleAddActivity(event) {
			console.log('üìù Adding new activity');
			event.preventDefault();
			
			const formData = new FormData(event.target);
			const activityData = {
				activityId: '', // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
				activityName: document.getElementById('activity-name').value.trim(),
				activityDate: document.getElementById('activity-date-input').value,
				round: parseInt(document.getElementById('activity-round-input').value),
				buddhistYear: parseInt(document.getElementById('activity-year-input').value)
			};

			console.log('üìã New activity data:', activityData);
			console.log('üïí Raw date input value:', document.getElementById('activity-date-input').value);

			// ‡∏•‡πâ‡∏≤‡∏á highlight ‡πÄ‡∏î‡∏¥‡∏°
			['activity-name','activity-date-input','activity-round-input','activity-year-input'].forEach(id => {
				const el = document.getElementById(id);
				if (el) el.classList.remove('border-red-500','focus:border-red-500','focus:ring-red-500');
			});

			const missing = [];
			if (!activityData.activityName) missing.push('‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
			if (!activityData.activityDate) missing.push('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î');
			if (!activityData.round || isNaN(activityData.round)) missing.push('‡∏£‡∏≠‡∏ö');
			if (!activityData.buddhistYear || isNaN(activityData.buddhistYear)) missing.push('‡∏õ‡∏µ ‡∏û.‡∏®.');

			if (missing.length) {
				showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö: ' + missing.join(', '), 'error');
				// ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
				if (!activityData.activityName) document.getElementById('activity-name').classList.add('border-red-500','focus:border-red-500','focus:ring-red-500');
				if (!activityData.activityDate) document.getElementById('activity-date-input').classList.add('border-red-500','focus:border-red-500','focus:ring-red-500');
				if (!activityData.round || isNaN(activityData.round)) document.getElementById('activity-round-input').classList.add('border-red-500','focus:border-red-500','focus:ring-red-500');
				if (!activityData.buddhistYear || isNaN(activityData.buddhistYear)) document.getElementById('activity-year-input').classList.add('border-red-500','focus:border-red-500','focus:ring-red-500');
				return;
			}

			try {
				showMessage('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...', 'info');
				console.log('üì§ Sending activity data:', activityData);
				
				const response = await fetchFromScript('addActivity', activityData);
				console.log('üì• Add activity response:', response);
				
				if (response.status === 'success') {
					const generatedId = response.activityId || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏£‡∏´‡∏±‡∏™';
					showMessage(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏´‡∏±‡∏™: ${generatedId}`, 'success');
					addActivityForm.reset();
					updateActivityIdPreview(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï preview ‡∏´‡∏•‡∏±‡∏á reset
					await loadActivitiesList(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
					await loadActivities(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î dropdown ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
					console.log('‚úÖ Activity added and lists refreshed');
				} else {
					showMessage('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ: ' + response.message, 'error');
				}
			} catch (error) {
				console.error('‚ùå Error adding activity:', error);
				showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
			}
		}

		/**
		 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
		 */
		function editActivity(activityName) {
			const target = currentActivities?.find(a => a.name === activityName);
			if (!target) {
				showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'error');
				return;
			}
			openEditActivityModal(target);
		}

		// Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
		function openEditActivityModal(activity){
			let modal = document.getElementById('edit-activity-modal');
			if (!modal){
				modal = document.createElement('div');
				modal.id = 'edit-activity-modal';
				modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4';
				modal.innerHTML = `
					<div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
						<h3 class="text-lg font-semibold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
						<div class="space-y-4">
							<div>
								<label class="block text-sm text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
								<input id="edit-activity-id" disabled class="mt-1 w-full px-3 py-2 border rounded-md bg-gray-50 text-gray-500" />
							</div>
							<div>
								<label class="block text-sm text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
								<input id="edit-activity-name" class="mt-1 w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
							</div>
							<div class="grid grid-cols-2 gap-4">
								<div>
									<label class="block text-sm text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î</label>
									<input type="date" id="edit-activity-date" class="mt-1 w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
								</div>
								<div>
									<label class="block text-sm text-gray-700">‡∏£‡∏≠‡∏ö</label>
									<select id="edit-activity-round" class="mt-1 w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
										<option value="1">1</option>
										<option value="2">2</option>
									</select>
								</div>
							</div>
							<div>
								<label class="block text-sm text-gray-700">‡∏õ‡∏µ ‡∏û.‡∏®.</label>
								<input type="number" id="edit-activity-year" class="mt-1 w-full px-3 py-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
							</div>
						</div>
						<div class="flex justify-end space-x-3 mt-6">
							<button type="button" id="btn-cancel-edit-activity" class="px-4 py-2 text-sm rounded-md border bg-white hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
							<button type="button" id="btn-save-edit-activity" class="px-4 py-2 text-sm rounded-md bg-indigo-600 text-white hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
						</div>
						<button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600" id="btn-close-edit-activity" title="‡∏õ‡∏¥‡∏î">‚úï</button>
					</div>`;
				document.body.appendChild(modal);
			}
			// ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤
			modal.querySelector('#edit-activity-id').value = activity.id || '(Auto)';
			modal.querySelector('#edit-activity-name').value = activity.name || '';
			// ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà dd/MM/yyyy -> yyyy-MM-dd
			let isoDate = '';
			if (activity.date && activity.date.includes('/')) {
				const p = activity.date.split('/'); // dd/MM/yyyy
				if (p.length===3) isoDate = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
			}
			modal.querySelector('#edit-activity-date').value = isoDate;
			modal.querySelector('#edit-activity-round').value = activity.round || '1';
			modal.querySelector('#edit-activity-year').value = activity.buddhistYear || '';
			modal.classList.remove('hidden');
			
			const closeFn = ()=>{modal.classList.add('hidden');};
			modal.querySelector('#btn-close-edit-activity').onclick = closeFn;
			modal.querySelector('#btn-cancel-edit-activity').onclick = closeFn;
			modal.onclick = (e)=>{ if(e.target===modal) closeFn(); };
			modal.querySelector('#btn-save-edit-activity').onclick = async ()=>{
				const newName = modal.querySelector('#edit-activity-name').value.trim();
				const newDate = modal.querySelector('#edit-activity-date').value;
				const newRound = parseInt(modal.querySelector('#edit-activity-round').value);
				const newYear = parseInt(modal.querySelector('#edit-activity-year').value);
				const missing=[];
				if(!newName) missing.push('‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
				if(!newDate) missing.push('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î');
				if(!newRound) missing.push('‡∏£‡∏≠‡∏ö');
				if(!newYear) missing.push('‡∏õ‡∏µ ‡∏û.‡∏®.');
				if(missing.length){
					showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å: '+missing.join(', '),'error');
					return;
				}
				try {
					showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...','info');
					const payload = {
						originalName: activity.name,
						activityName: newName,
						activityDate: newDate,
						round: newRound,
						buddhistYear: newYear
					};
					const resp = await fetchFromScript('updateActivity', payload);
					if(resp.status==='success'){
						showMessage('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
						closeFn();
						await loadActivitiesList();
						await loadActivities();
					}else{
						if(resp.message && resp.message.includes('Unknown action: updateActivity')){
							showMessage('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå (deploy) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateActivity ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Deploy Google Apps Script ‡πÉ‡∏´‡∏°‡πà','error');
							console.warn('Suggest redeploy: missing updateActivity on server');
						}else{
							showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+resp.message,'error');
						}
					}
				}catch(err){
					console.error('Update error',err);
					showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+err.message,'error');
				}
			};
		}

		/**
		 * ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
		 */
		async function deleteActivity(activityName) {
			console.log('üóëÔ∏è Deleting activity:', activityName);
			
			if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activityName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
				console.log('‚ùå Delete cancelled by user');
				return;
			}

			try {
				showMessage('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...', 'info');
				console.log('üì§ Sending delete request for:', activityName);
				
				const response = await fetchFromScript('deleteActivity', { name: activityName });
				console.log('üì• Delete response:', response);
				
				if (response.status === 'success') {
					showMessage('‚úÖ ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
					await loadActivitiesList(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
					await loadActivities(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î dropdown ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
					console.log('‚úÖ Activity deleted and lists refreshed');
				} else {
					showMessage('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ: ' + response.message, 'error');
				}
			} catch (error) {
				console.error('‚ùå Error deleting activity:', error);
				showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
			}
		}

		/**
		 * ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
		 */
		function refreshActivityList() {
			loadActivitiesList();
		}

		/**
		 * ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
		 */
		function formatDisplayDate(dateString) {
			try {
				const date = new Date(dateString);
				return date.toLocaleDateString('th-TH', {
					year: 'numeric',
					month: 'long',
					day: 'numeric'
				});
			} catch (error) {
				return dateString;
			}
		}

		/**
		 * ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏µ
		 */
		function filterActivitiesList() {
			const searchTerm = activitySearch.value.toLowerCase();
			const selectedYear = yearFilterActivities.value;
			const rows = activitiesTableBody.querySelectorAll('tr');

			rows.forEach(row => {
				const activityName = row.cells[0]?.textContent.toLowerCase() || '';
				const activityYear = row.cells[3]?.textContent || '';
				
				const matchesSearch = !searchTerm || activityName.includes(searchTerm);
				const matchesYear = !selectedYear || activityYear === selectedYear;
				
				if (matchesSearch && matchesYear) {
					row.style.display = '';
				} else {
					row.style.display = 'none';
				}
			});
		}

		// --- EVENT LISTENERS ---
		tabRecord.addEventListener('click', () => switchView('record'));
		tabDashboard.addEventListener('click', () => switchView('dashboard'));
		tabActivities.addEventListener('click', () => switchView('activities'));
		activityForm.addEventListener('submit', handleFormSubmit);
		addActivityForm.addEventListener('submit', handleAddActivity);
		loadDashboardBtn.addEventListener('click', loadDashboardData);

		// ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard
		exportExcelBtn.addEventListener('click', async (e) => {
			 e.preventDefault();
			 try {
				 const year = yearFilter.value;
				 const round = roundFilter.value;
				 exportExcelBtn.disabled = true;
				 exportExcelBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å...';

				 const resp = await fetchFromScript('exportDashboardToExcel', { year, round });
				 if (resp.status === 'success' && resp.file) {
					 const linkHtml = `<div class="p-3 rounded border border-green-200 bg-green-50 text-green-700">‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß: <a class="underline font-medium" href="${resp.file.downloadUrl}" target="_blank" rel="noopener">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (${resp.file.name})</a></div>`;
					 dashboardResults.insertAdjacentHTML('afterbegin', linkHtml);
				 } else {
					 showMessage(resp.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
				 }
			 } catch (err) {
				 console.error('Export Excel error:', err);
				 showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå', 'error');
			 } finally {
				 exportExcelBtn.disabled = false;
				 exportExcelBtn.textContent = '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel';
			 }
		});
		
		// ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å PScode
		userPscode.addEventListener('blur', (e) => {
			checkUser(e.target.value.trim());
		});
		
		userPscode.addEventListener('input', (e) => {
			if (e.target.value.trim().length >= 3) {
				checkUser(e.target.value.trim());
			}
		});

		// Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Activity Management
		activitySearch.addEventListener('input', filterActivitiesList);
		yearFilterActivities.addEventListener('change', filterActivitiesList);
		
		// Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Activity ID Preview
		document.getElementById('activity-id').addEventListener('input', updateActivityIdPreview);
		document.getElementById('activity-round-input').addEventListener('input', updateActivityIdPreview);
		document.getElementById('activity-year-input').addEventListener('input', updateActivityIdPreview);
		
		// Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
		activitySelect.addEventListener('change', (e) => {
			updateActivityDetails(e.target.value);
		});
		
		// Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û
		imageUpload.addEventListener('change', (e) => {
			const file = e.target.files[0];
			const clearButton = document.getElementById('clear-image');
			
			if (file) {
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå (5MB = 5 * 1024 * 1024 bytes)
				if (file.size > 5 * 1024 * 1024) {
					showMessage('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)', 'error');
					imageUpload.value = '';
					imagePreview.classList.add('hidden');
					clearButton.classList.add('hidden');
					updateRecordSummary();
					return;
				}
				
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
				const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
				if (!allowedTypes.includes(file.type)) {
					showMessage('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ JPG, PNG, WEBP)', 'error');
					imageUpload.value = '';
					imagePreview.classList.add('hidden');
					clearButton.classList.add('hidden');
					updateRecordSummary();
					return;
				}
				
				previewImage(file);
				clearButton.classList.remove('hidden');
			} else {
				imagePreview.classList.add('hidden');
				clearButton.classList.add('hidden');
				updateRecordSummary();
			}
		});

		// --- DEBUGGING FUNCTIONS ---
		function debugSystem() {
			console.log('üîç System Debug Info:');
			console.log('- Script URL:', SCRIPT_URL);
			console.log('- Current User:', currentUser);
			console.log('- User Coordinates:', userCoordinates);
			console.log('- Activity Form:', activityForm);
			console.log('- Add Activity Form:', addActivityForm);
			console.log('- Activity Select:', activitySelect);
			console.log('- Is Submitting:', isSubmitting);
		}

		// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
		function testSave() {
			console.log('üß™ Testing save functionality...');
			const testPayload = {
				pscode: 'TEST001',
				activity: 'test',
				image: null,
				coordinates: 'Test Location',
				latitude: 13.7563,
				longitude: 100.5018
			};
			
			fetchFromScript('addRecord', testPayload)
				.then(response => {
					console.log('‚úÖ Test save successful:', response);
					showMessage('‚úÖ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
				})
				.catch(error => {
					console.error('‚ùå Test save failed:', error);
					showMessage('‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
				});
		}

		// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Developer Mode
		function addDebugButtons() {
			if (window.location.search.includes('debug=true')) {
				const debugDiv = document.createElement('div');
				debugDiv.className = 'fixed top-4 right-4 z-50 space-x-2';
				debugDiv.innerHTML = `
					<button onclick="debugSystem()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">Debug</button>
					<button onclick="testSave()" class="px-3 py-1 bg-green-500 text-white rounded text-sm">Test Save</button>
					<button onclick="testConnection()" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm">Test Connection</button>
				`;
				document.body.appendChild(debugDiv);
			}
		}

		// --- INITIALIZATION ---
		window.addEventListener('load', () => {
			console.log('üöÄ Application starting...');
			try {
				switchView('record');
				loadActivities();
				getCoordinates();
				addDebugButtons();
				updateActivityIdPreview(); // ‡πÅ‡∏™‡∏î‡∏á preview ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
				console.log('‚úÖ Application initialized successfully');
			} catch (error) {
				console.error('‚ùå Application initialization failed:', error);
				showMessage('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: ' + error.message, 'error');
			}
		});
	</script>
</body>
</html>